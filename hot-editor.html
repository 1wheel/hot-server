<!doctype html>

<title>loading...</title>
<meta charset="utf-8"/>

<link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="node_modules/codemirror/addon/fold/foldgutter.css">
<link rel="stylesheet" href="node_modules/codemirror/addon/dialog/dialog.css">
<link rel="stylesheet" href="node_modules/codemirror/theme/mbo.css">

<script src="node_modules/codemirror/lib/codemirror.js"></script>
<script src="node_modules/codemirror/addon/search/searchcursor.js"></script>
<script src="node_modules/codemirror/addon/search/search.js"></script>
<script src="node_modules/codemirror/addon/dialog/dialog.js"></script>
<script src="node_modules/codemirror/addon/edit/matchbrackets.js"></script>
<script src="node_modules/codemirror/addon/edit/closebrackets.js"></script>
<script src="node_modules/codemirror/addon/comment/comment.js"></script>
<script src="node_modules/codemirror/addon/wrap/hardwrap.js"></script>
<script src="node_modules/codemirror/addon/fold/foldcode.js"></script>
<script src="node_modules/codemirror/addon/fold/brace-fold.js"></script>
<script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
<script src="node_modules/codemirror/mode/css/css.js"></script>
<script src="node_modules/codemirror/mode/htmlmixed/htmlmixed.js"></script>
<script src="node_modules/codemirror/keymap/sublime.js"></script>


<script src="https://roadtolarissa.com/worlds-group-2017/d3_.js"></script>
<style>
  html, body{
    margin: 0px;
    width: 100%;
    height: 100%;
  }

  #code-container{
    width: 100vw;
    height: 100%;
  }

  .CodeMirror-linenumbers { padding: 0 8px; }

  .cm-s-mbo .CodeMirror-gutters {
    background: #2c2c2c;
  }
</style>


<div id='code-container'></div>

<script>

!(async function(){

  var path = (new URLSearchParams(window.location.search)).get('hotEditorPath')
  if (!path) return displayFileList()

  var value = await(await fetch(path)).text()

  console.log('loaded file')

  var fileName = _.last(path.split('/'))
  d3.select('title').text(fileName)

  var type = _.last(path.split('.'))
  var mode = type == 'js' ? 'javascript' : 
    type == 'html' ? 'htmlmixed' :
    type == 'css' ? 'css' : ''
  // TODO HTML mode not loading

  if (type == 'html'){
    var htmlInject = await(await fetch('/html-inject.html')).text()
    value = value.replace(htmlInject, '')
  }

  console.log({mode})

  var cm = CodeMirror(d3.select('#code-container').node(), {
    value,
    lineNumbers: true,
    mode,
    keyMap: 'sublime',
    autoCloseBrackets: true,
    matchBrackets: true,
    showCursorWhenSelecting: true,
    theme: 'mbo',
    tabSize: 2,
    lineWrapping: true,
    autofocus: true,
  })

  // send update on save
  var bc = new BroadcastChannel('file_update')

  d3.select(window).on('keydown', () => {
    if (!event.ctrlKey && !event.metaKey) return
    if (String.fromCharCode(event.which).toLowerCase() != 's') return

    event.preventDefault()

    var msg = {path, type, str: cm.getValue()}
    bc.postMessage(msg)

    // write to disk

    fetch('/save', {
      method: 'POST',
      body: JSON.stringify(msg)
    })

    // TODO only remove changed title after success
  })

  bc.onmessage = d => console.log(d, d.data)


  // full screen editor
  var setWindowSize = () => cm.setSize(innerWidth, innerHeight)
  setWindowSize()
  d3.select(window).on('resize', setWindowSize)
})()


async function displayFileList(){
  var files = await(await fetch('hot-editor-files.json')).json()

  d3.select('body').html('')
    .st({margin: 10, marginBottom: 100, fontFamily: 'monospace'})
    .appendMany('div', files)
    .st({marginTop: d => d.includes('.') ? 0 : 10})
    .append('a')
    .text(d => d)
    // .st({fontWeight: d => d.includes('.') ? 400 : 600 })
    .filter(d => d.includes('.'))
    .at({href: d => '/hot-editor.html?hotEditorPath=' + encodeURIComponent(d) })

  console.log(files)
}


// TODO check if file has updated outside of editor and alert








</script>



</article>
